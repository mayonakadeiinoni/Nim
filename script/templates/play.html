<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Nimã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .diamond-blocks {
        font-size: 1.5rem;
        color: #0dcaf0;
      }
      .alert.alert-info.text-center {
        font-size: 3.5rem;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <h1 class="text-center mb-4">ğŸ® Nim ã‚²ãƒ¼ãƒ  ğŸ®</h1>

      <!-- å±±ã®çŠ¶æ…‹ -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">ç¾åœ¨ã®çŠ¶æ…‹</div>
        <div class="card-body" id="mounts">
          <p class="text-muted">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>

      <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="card mb-4 shadow-sm">
        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¬„ -->
        <div id="message" class="alert alert-info text-center" role="alert">
          ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
        </div>
        <div class="card-header bg-success text-white">æ“ä½œãƒ‘ãƒãƒ«</div>
        <div class="card-body">
          <form>
            <div class="mb-3">
              <label for="index" class="form-label">å±±ã®ç•ªå·</label>
              <input type="number" id="index" min="0" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="amount" class="form-label">ã¨ã‚‹é‡</label>
              <input type="number" id="amount" min="1" class="form-control" />
            </div>
            <div class="d-grid gap-2">
              <button
                type="button"
                class="btn btn-primary"
                onclick="Move.HumanMove()"
                id="move_button"
              >
                ãƒ€ã‚¤ãƒ¤ã‚’ã¨ã‚Šã¾ã™
              </button>
              <button
                type="button"
                class="btn btn-danger"
                onclick="resetGame()"
                id="reset_button"
              >
                ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
      class Move {
        static async HumanMove() {
          const index = parseInt(document.getElementById("index").value);
          const amount = parseInt(document.getElementById("amount").value);

          const res = await fetch("/move", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ index, amount, now_player_type: "Human" }),
          });

          const data = await res.json();
          const msg = document.getElementById("message");
          msg.textContent = data.message;

          if (data.success) {
            if (data.win) {
              location.href = "/win";
            } else {
              fetchState(); // â‘  äººãŒæ‰“ã£ãŸçµæœã‚’æç”»
            }
          }

          const playerType = data.now_player_type;

          if (playerType) {
            const parsed = playerType;
            const cpIndex = data.turn;
            console.log(data.turn);
            if (parsed === "CP") {
              await toggleInput(false);

              const div = document.createElement("div");
              div.textContent = `CPã®æ‰‹ç•ªã§ã™â€¦å°‘ã—å¾…ã£ã¦æ‰“ã¡ã¾ã™`;
              const container = document.getElementById("mounts");
              container.innerHTML = "";
              container.appendChild(div);
              await wait(3000); // â‘£ CPã®æç”»å¾Œã«ã¾ãŸå°‘ã—å¾…ã¤

              sessionStorage.setItem("cp_initialized", "true");

              Move.CPMove(data.now_player_type); // â‘¢ CPãŒæ‰“ã¤
              await wait(2000); // â‘£ CPã®æç”»å¾Œã«ã¾ãŸå°‘ã—å¾…ã¤
              return;
            }
          }

          toggleInput(true);
        }

        static async CPMove() {
          const res = await fetch("/move", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ now_player_type: "CP" }),
          });

          const data = await res.json();
          const msg = document.getElementById("message");
          msg.textContent = data.message;

          if (data.success) {
            if (data.win) {
              location.href = "/win";
            } else {
              fetchState();
            }
          }
        }
      }

      async function fetchState() {
        try {
          const response = await fetch("/get_state");
          const data = await response.json();

          const container = document.getElementById("mounts");
          container.innerHTML = "";

          const h2 = document.createElement("h2");
          const div = document.createElement("div");

          h2.textContent = `ä»Šã®æ‰‹ç•ªï¼š${
            data.turn === 0
              ? `å…ˆè¡Œï¼š${data.now_player_name}`
              : `å¾Œæ”»ï¼š${data.now_player_name}`
          }`;

          div.appendChild(h2);
          container.appendChild(div);

          data.mounts.forEach((count, index) => {
            const div = document.createElement("div");
            div.style.marginBottom = "12px";

            const label = document.createElement("span");
            label.textContent = `å±± ${index}: `;
            label.style.display = "inline-block";
            label.style.width = "80px";

            const blocks = document.createElement("span");
            blocks.style.display = "inline-block";
            blocks.style.fontSize = "20px";
            blocks.style.letterSpacing = "2px";
            blocks.classList.add("diamond-blocks");
            blocks.textContent = "ğŸ’".repeat(count);

            const countText = document.createElement("span");
            countText.style.marginLeft = "10px";
            countText.textContent = `(${count})`;

            div.appendChild(label);
            div.appendChild(blocks);
            div.appendChild(countText);

            container.appendChild(div);
          });

          const playerType = data.now_player_type;
          const alreadyStarted = sessionStorage.getItem("cp_initialized");

          console.log(`alreadyStarted: ${alreadyStarted}`);

          if (playerType && !alreadyStarted) {
            const parsed = playerType;
            const cpIndex = data.turn;

            if (parsed === "CP") {
              await toggleInput(false);
              await wait(3000);
              const div = document.createElement("div");
              div.textContent = `CPã®åˆæ‰‹ç•ªã§ã™â€¦å°‘ã—å¾…ã£ã¦æ‰“ã¡ã¾ã™`;
              container.appendChild(div);

              sessionStorage.setItem("cp_initialized", "true");

              Move.CPMove(data.now_player_type);
              return;
            }
          }
          await wait(3000);
          toggleInput(true);
        } catch (error) {
          document.getElementById("mounts").textContent =
            "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
          console.error("fetchState ã‚¨ãƒ©ãƒ¼è©³ç´°:", error);
        }
      }

      function wait(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      async function toggleInput(enable) {
        document.getElementById("index").disabled = !enable;
        document.getElementById("amount").disabled = !enable;
        document.getElementById("move_button").disabled = !enable;
        document.getElementById("reset_button").disabled = !enable;
      }

      async function resetGame() {
        const res = await fetch("/reset", {
          method: "POST",
        });
        const data = await res.json();
        sessionStorage.removeItem("cp_initialized");
        console.log("session" + sessionStorage.getItem("cp_initialized"));
        if (sessionStorage.getItem("cp_initialized") === null) {
          console.log("å‰Šé™¤æˆåŠŸ");
        } else {
          console.log("ã¾ã æ®‹ã£ã¦ã‚‹");
        }

        if (data.success) {
          alert(data.message);
          fetchState();
        }
      }

      fetchState();
    </script>
  </body>
</html>
