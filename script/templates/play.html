<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Nimゲームの状態</title>
  </head>
  <body>
    <h1>Nimゲームの状態</h1>
    <div id="mounts">読み込み中...</div>

    <script>
      class Move {
        static async HumanMove() {
          const index = parseInt(document.getElementById("index").value);
          const amount = parseInt(document.getElementById("amount").value);

          const res = await fetch("/move", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ index, amount, now_player_type: "Human" }),
          });

          const data = await res.json();
          const msg = document.getElementById("message");
          msg.textContent = data.message;

          if (data.success) {
            if (data.win) {
              location.href = "/win";
            } else {
              await fetchState(); // ① 人が打った結果を描画
              await wait(3000); // ② 描画後に1秒待つ
            }
          }

          const playerType = data.now_player_type;

          if (playerType) {
            const parsed = playerType;
            const cpIndex = data.turn;
            if (parsed === "CP") {
              toggleInput(false);
              await wait(1000); // ④ CPの描画後にまた少し待つ
              const div = document.createElement("div");
              div.textContent = `CPの初手番です…少し待って打ちます`;
              const container = document.getElementById("mounts");
              container.innerHTML = "";
              container.appendChild(div);

              sessionStorage.setItem("cp_initialized", "true");

              await Move.CPMove(data.now_player_type); // ③ CPが打つ（CPMoveの中でまたfetchStateが呼ばれる）
              await wait(3000); // ④ CPの描画後にまた少し待つ
              return; // ここで抜けて、二重にtoggleしないように
            }
          }

          toggleInput(true);
        }

        static async CPMove() {
          const res = await fetch("/move", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ now_player_type: "CP" }),
          });

          const data = await res.json();
          const msg = document.getElementById("message");
          msg.textContent = data.message;

          if (data.success) {
            if (data.win) {
              location.href = "/win";
            } else {
              await fetchState(); // CPが打ったあとの描画
              await wait(1000); // ④ CPの描画後にまた少し待つ
            }
          }
        }
      }

      async function fetchState() {
        try {
          const response = await fetch("/get_state");
          const data = await response.json();

          const container = document.getElementById("mounts");
          container.innerHTML = "";

          const h2 = document.createElement("h2");
          const div = document.createElement("div");

          h2.textContent = `今の手番：${
            data.turn === 0
              ? `先行：${data.now_player_name}`
              : `後攻：${data.now_player_name}`
          }`;

          div.appendChild(h2);
          container.appendChild(div);

          data.mounts.forEach((count, index) => {
            const div = document.createElement("div");
            div.textContent = `山:${index} 残り:${count}`;
            container.appendChild(div);
          });

          const playerType = data.now_player_type;
          const alreadyStarted = sessionStorage.getItem("cp_initialized");
          console.log(alreadyStarted);

          if (playerType && !alreadyStarted) {
            const parsed = playerType;
            const cpIndex = data.turn;
            if (parsed === "CP") {
              const div = document.createElement("div");
              div.textContent = `CPの初手番です…少し待って打ちます`;
              container.appendChild(div);
              toggleInput(false);

              sessionStorage.setItem("cp_initialized", "true");

              setTimeout(() => {
                Move.CPMove(data.now_player_type); // 自動実行
              }, 1000);
              return; // ここで抜けて、二重にtoggleしないように
            }
          }

          toggleInput(true);
        } catch (error) {
          document.getElementById("mounts").textContent =
            "エラーが発生しました";
        }
      }
      function wait(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      function toggleInput(enable) {
        document.getElementById("index").disabled = !enable;
        document.getElementById("amount").disabled = !enable;
        document.getElementById("move_button").disabled = !enable;
        document.getElementById("reset_button").disabled = !enable;
      }

      async function resetGame() {
        const res = await fetch("/reset", {
          method: "POST",
        });
        const data = await res.json();
        sessionStorage.removeItem("cp_initialized");
        if (data.success) {
          alert(data.message);
          fetchState(); // mount再表示
        }
      }

      fetchState();
    </script>
    <!-- 入力部分-->
    <h2>操作</h2>
    <label>山の番号： <input type="number" id="index" min="0" /> </label><br />
    <label>とる量： <input type="number" id="amount" min="1" /></label><br />
    <button onclick="Move.HumanMove()" id="move_button">実行</button>
    <button onclick="resetGame()" id="reset_button">リセット</button>

    <p id="message"></p>
    <!-- メッセージ表示用 -->
  </body>
</html>
