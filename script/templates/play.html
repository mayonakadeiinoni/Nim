<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Nimã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹</title>
  </head>
  <body>
    <h1>Nimã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹</h1>
    <div id="mounts">èª­ã¿è¾¼ã¿ä¸­...</div>

    <script>
      class Move {
        static async HumanMove() {
          const index = parseInt(document.getElementById("index").value);
          const amount = parseInt(document.getElementById("amount").value);

          const res = await fetch("/move", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ index, amount, now_player_type: "Human" }),
          });

          const data = await res.json();
          const msg = document.getElementById("message");
          msg.textContent = data.message;

          if (data.success) {
            if (data.win) {
              location.href = "/win";
            } else {
              fetchState(); // â‘  äººãŒæ‰“ã£ãŸçµæœã‚’æç”»
            }
          }

          const playerType = data.now_player_type;

          if (playerType) {
            const parsed = playerType;
            const cpIndex = data.turn;
            console.log(data.turn);
            if (parsed === "CP") {
              await toggleInput(false);

              const div = document.createElement("div");
              div.textContent = `CPã®æ‰‹ç•ªã§ã™â€¦å°‘ã—å¾…ã£ã¦æ‰“ã¡ã¾ã™`;
              const container = document.getElementById("mounts");
              container.innerHTML = "";
              container.appendChild(div);
              await wait(3000); // â‘£ CPã®æç”»å¾Œã«ã¾ãŸå°‘ã—å¾…ã¤

              sessionStorage.setItem("cp_initialized", "true");

              Move.CPMove(data.now_player_type); // â‘¢ CPãŒæ‰“ã¤ï¼ˆCPMoveã®ä¸­ã§ã¾ãŸfetchStateãŒå‘¼ã°ã‚Œã‚‹ï¼‰
              await wait(2000); // â‘£ CPã®æç”»å¾Œã«ã¾ãŸå°‘ã—å¾…ã¤
              return; // ã“ã“ã§æŠœã‘ã¦ã€äºŒé‡ã«toggleã—ãªã„ã‚ˆã†ã«
            }
          }

          toggleInput(true);
        }

        static async CPMove() {
          const res = await fetch("/move", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ now_player_type: "CP" }),
          });

          const data = await res.json();
          const msg = document.getElementById("message");
          msg.textContent = data.message;

          if (data.success) {
            if (data.win) {
              location.href = "/win";
            } else {
              fetchState(); // CPãŒæ‰“ã£ãŸã‚ã¨ã®æç”»
              //  await wait(1000); // â‘£ CPã®æç”»å¾Œã«ã¾ãŸå°‘ã—å¾…ã¤
            }
          }
        }
      }

      async function fetchState() {
        try {
          const response = await fetch("/get_state");
          const data = await response.json();

          const container = document.getElementById("mounts");
          container.innerHTML = "";

          const h2 = document.createElement("h2");
          const div = document.createElement("div");

          h2.textContent = `ä»Šã®æ‰‹ç•ªï¼š${
            data.turn === 0
              ? `å…ˆè¡Œï¼š${data.now_player_name}`
              : `å¾Œæ”»ï¼š${data.now_player_name}`
          }`;

          div.appendChild(h2);
          container.appendChild(div);

          data.mounts.forEach((count, index) => {
            const div = document.createElement("div");
            div.style.marginBottom = "12px";

            const label = document.createElement("span");
            label.textContent = `å±± ${index}: `;
            label.style.display = "inline-block";
            label.style.width = "80px";

            const blocks = document.createElement("span");
            blocks.style.display = "inline-block";
            blocks.style.fontSize = "20px";
            blocks.style.letterSpacing = "2px";
            blocks.classList.add("diamond-blocks");

            blocks.textContent = "ğŸ’".repeat(count);

            const countText = document.createElement("span");
            countText.style.marginLeft = "10px";
            countText.textContent = `(${count})`;

            div.appendChild(label);
            div.appendChild(blocks);
            div.appendChild(countText);

            container.appendChild(div);
          });

          const playerType = data.now_player_type;
          const alreadyStarted = sessionStorage.getItem("cp_initialized");

          console.log(`alreadyStarted: ${alreadyStarted}`);

          if (playerType && !alreadyStarted) {
            const parsed = playerType;
            const cpIndex = data.turn;

            if (parsed === "CP") {
              await toggleInput(false);
              await wait(3000);
              const div = document.createElement("div");
              div.textContent = `CPã®åˆæ‰‹ç•ªã§ã™â€¦å°‘ã—å¾…ã£ã¦æ‰“ã¡ã¾ã™`;
              container.appendChild(div);

              sessionStorage.setItem("cp_initialized", "true");

              Move.CPMove(data.now_player_type);
              return;
            }
          }
          await wait(3000); // â‘£ CPã®æç”»å¾Œã«ã¾ãŸå°‘ã—å¾…ã¤

          toggleInput(true);
        } catch (error) {
          document.getElementById("mounts").textContent =
            "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
          console.error("fetchState ã‚¨ãƒ©ãƒ¼è©³ç´°:", error);
        }
      }
      function wait(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      async function toggleInput(enable) {
        document.getElementById("index").disabled = !enable;
        document.getElementById("amount").disabled = !enable;
        document.getElementById("move_button").disabled = !enable;
        document.getElementById("reset_button").disabled = !enable;
      }

      async function resetGame() {
        const res = await fetch("/reset", {
          method: "POST",
        });
        const data = await res.json();
        sessionStorage.removeItem("cp_initialized");
        console.log("session" + sessionStorage.getItem("cp_initialized"));
        if (sessionStorage.getItem("cp_initialized") === null) {
          console.log("å‰Šé™¤æˆåŠŸ");
        } else {
          console.log("ã¾ã æ®‹ã£ã¦ã‚‹");
        }

        if (data.success) {
          alert(data.message);
          fetchState(); // mountå†è¡¨ç¤º
        }
      }

      fetchState();
    </script>
    <!-- å…¥åŠ›éƒ¨åˆ†-->
    <h2>æ“ä½œ</h2>
    <label>å±±ã®ç•ªå·ï¼š <input type="number" id="index" min="0" /> </label><br />
    <label>ã¨ã‚‹é‡ï¼š <input type="number" id="amount" min="1" /></label><br />
    <button onclick="Move.HumanMove()" id="move_button">å®Ÿè¡Œ</button>
    <button onclick="resetGame()" id="reset_button">ãƒªã‚»ãƒƒãƒˆ</button>

    <p id="message"></p>
    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ -->
  </body>
</html>
